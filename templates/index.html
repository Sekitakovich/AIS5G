<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script type="text/javascript" src="../static/jquery-3.5.0.min.js"></script>
    <link rel="stylesheet" href="../static/leaflet/leaflet.css">
    <script type="text/javascript" src="../static/leaflet/leaflet.js"></script>
    <script type="text/javascript" src="../static/leaflet-grayscale-master/TileLayer.Grayscale.js"></script>
    <script type="text/javascript" src="../static/js/leaflet.rotatedMarker.js"></script>
    <script type="text/javascript" src="../static/Leaflet.MovingMarker-master/MovingMarker.js"></script>
    <script type="text/javascript" src="../static/leaflet.bouncemarker-master/bouncemarker.js"></script>
    <script type="text/javascript" src="../static/reconnecting-websocket-master/reconnecting-websocket.js"></script>
    <script type="text/javascript" src="classes.js"></script>
    <script type="text/javascript" src="main.js"></script>
    <link rel="stylesheet" href="../static/magic-master/dist/magic.min.css">
    <style>
        .map {
            width: 1024px;
            height: 768px;
        }

        @keyframes fade {
            from {
                opacity: 0.5;
            }
        }

        .tako {
            animation: fade 0.5s infinite alternate;
        }
    </style>
</head>
<body>
<div id="map" class="map"></div>
<input type="button" value="speak">
<script type="text/javascript">
    jQuery(document).ready(function () {
        console.log('start');
// -------------------------------------------------------------------------------------------------
        const main = new Main('map');
// -------------------------------------------------------------------------------------------------
        jQuery.ajax({
            url: 'shiplist',
            type: 'GET',
            dataType: 'json',
        }).done(function (data) { //console.log(data)
            for (let k in data) { //console.log(data[k]['profeel'])
                main.setProfeel(k, data[k]['profeel'], false);
                main.move(k, data[k]['location']);
            }
            console.log('### preload completed');
        });
// -------------------------------------------------------------------------------------------------

        const w = jQuery(window);
        w.on('focus', function (e) {
            main.isWindowActive = true;
            console.log('Active');
        });
        w.on('blur', function (e) {
            main.isWindowActive = false;
            console.log('not Active');
        });

        const startSession = function () {
            const wsURL = 'ws://' + location.host + '/ws'
            const ws = new ReconnectingWebSocket(wsURL);
            ws.onmessage = function (message) {
                const data = JSON.parse(message['data']);
                const mmsi = data['mmsi'];
                const type = data['type'];
                switch (type) {
                    // case 'debut':
                    //     main.append(mmsi, data['profeel'], data['location'], data['at']);
                    //     break;
                    case 'profeel':
                        const profeel = data['profeel'];
                        main.setProfeel(mmsi, profeel, true);
                        break;
                    case 'live':
                        const location = data['location'];
                        // main.append(mmsi, location);
                        main.move(mmsi, location);
                        // console.log(location);
                        break;
                    case 'retire':
                        main.expire(mmsi);
                        break;
                    default:
                        console.log(data);
                        break;
                }
            }
        }
        startSession();

    });
</script>
</body>
</html>